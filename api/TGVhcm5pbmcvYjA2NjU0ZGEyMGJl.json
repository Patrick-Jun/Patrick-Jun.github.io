{"title":"使用Let's Encrypt给node.js项目添加SSL证书","date":"2021-03-08T15:04:03.000Z","date_formatted":{"ll":"Mar 8, 2021","L":"03/08/2021","MM-DD":"03-08"},"link":"Learning/b06654da20be","tags":["JavaScript","Let's Encrypt","Nginx","Node","SSL","免费SSL证书"],"categories":["Learning"],"updated":"2021-03-08T16:04:25.333Z","content":"<p>使用Let’s Encrypt给node.js启动的项目配置。Nginx + node.js + Let’s Encript.</p>\n<span id=\"more\"></span>\n<p>本文是自己在网上各种查询，并成功配置后记录的详细步骤。</p>\n<h2 id=\"一、环境准备\">一、环境准备<a title=\"#一、环境准备\" href=\"#一、环境准备\"></a></h2>\n<ul>\n<li>nginx: 可参考 <a href=\"https://www.zzboy.cn/Learning/1e8a589a019b\" target=\"_blank\">Ubuntu 16.04搭建lnmp环境</a></li>\n<li>Certbot: 可参考 <a href=\"https://www.zzboy.cn/Learning/97cad6591dc5\" target=\"_blank\">Nginx用certbot获取Let’s Encrypt SSL证书</a></li>\n<li>node.js</li>\n</ul>\n<h2 id=\"二、配置步骤\">二、配置步骤<a title=\"#二、配置步骤\" href=\"#二、配置步骤\"></a></h2>\n<p>首先，先将你的node.js项目传到服务器，<code>npm i</code>安装好依赖，保证项目能启动起来，然后可以开始以下步骤了。</p>\n<h3 id=\"2.1-创建辅助文件\">2.1 创建辅助文件<a title=\"#2.1-创建辅助文件\" href=\"#2.1-创建辅助文件\"></a></h3>\n<p>首先，假设你的项目目录是 <code>/home/server/</code>，进入项目目录：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">cd /home/server</span><br></pre></td></tr></table></figure>\n<p>创建一个文件 <code>a.js</code>:</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// a.js</span></span><br><span class=\"line\"><span class=\"keyword\">const</span> express = <span class=\"built_in\">require</span>(<span class=\"string\">&#x27;express&#x27;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">const</span> app = express();</span><br><span class=\"line\"></span><br><span class=\"line\">app.use(express.static(__dirname, &#123; <span class=\"attr\">dotfiles</span>: <span class=\"string\">&#x27;allow&#x27;</span> &#125; ));</span><br><span class=\"line\">app.listen(<span class=\"number\">5000</span>, <span class=\"function\">() =&gt;</span> &#123;</span><br><span class=\"line\">  <span class=\"built_in\">console</span>.log(<span class=\"string\">&#x27;HTTP server running on port 5000&#x27;</span>);</span><br><span class=\"line\">&#125;);</span><br></pre></td></tr></table></figure>\n<p>创建一个目录<code>.well-known/acme-challenge</code>:</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mkdir -p .well-known/acme-challenge</span><br></pre></td></tr></table></figure>\n<p>添加<code>-p</code>可以同时创建两个目录，其中<code>acme-challenge</code>是<code>.well-known</code>的子目录。</p>\n<h3 id=\"2.2-编辑nginx配置文件\">2.2 编辑nginx配置文件<a title=\"#2.2-编辑nginx配置文件\" href=\"#2.2-编辑nginx配置文件\"></a></h3>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">vim /etc/nginx/conf.d/youdomain.com.conf</span><br></pre></td></tr></table></figure>\n<p>编辑你项目的nginx配置文件：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">server &#123;</span><br><span class=\"line\">  listen 80;</span><br><span class=\"line\"></span><br><span class=\"line\">  server_name youdomain.com; # 设置你的域名</span><br><span class=\"line\">  location / &#123;</span><br><span class=\"line\">    proxy_pass http://127.0.0.1:5000;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  location ^~ /.well-known/acme-challenge/ &#123;</span><br><span class=\"line\">    default_type &quot;text/plain&quot;;</span><br><span class=\"line\">    root     /home/server/; # 你的项目路径</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>保存nginx配置文件，并重启nginx服务：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">systemctl restart nginx</span><br></pre></td></tr></table></figure>\n<h3 id=\"2.3-开始获取证书\">2.3 开始获取证书<a title=\"#2.3-开始获取证书\" href=\"#2.3-开始获取证书\"></a></h3>\n<p>先启动辅助文件：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">node /home/server/a.js</span><br></pre></td></tr></table></figure>\n<p>新开一个窗口，通过cerbot启动下面命令：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">certbot certonly --manual -d youdomain.com</span><br></pre></td></tr></table></figure>\n<p>遇到<code>(Y)es/(N)o</code>的时候，输入<code>Y</code>，回车，然后你会看到类似这样的描述：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">NOTE: The IP of this machine will be publicly logged as having requested this</span><br><span class=\"line\">certificate. If you&#x27;re running certbot in manual mode on a machine that is not</span><br><span class=\"line\">your server, please ensure you&#x27;re okay with that.</span><br><span class=\"line\"></span><br><span class=\"line\">Are you OK with your IP being logged?</span><br><span class=\"line\"></span><br><span class=\"line\">- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -</span><br><span class=\"line\"></span><br><span class=\"line\">(Y)es/(N)o: Y</span><br><span class=\"line\"></span><br><span class=\"line\">- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -</span><br><span class=\"line\"></span><br><span class=\"line\">Create a file containing just this data:</span><br><span class=\"line\"></span><br><span class=\"line\">hoo8qxxxxxxxxxxxxxxxxxxxxxxxxxxxxBBJ2A.LTb3xxxxxxxxxxxxxxxxxxxxxxxxxxxxxoHys</span><br><span class=\"line\"></span><br><span class=\"line\">And make it available on your web server at this URL:</span><br><span class=\"line\"></span><br><span class=\"line\">http://youdomain.com/.well-known/acme-challenge/hoo8qxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxBBJ2A</span><br><span class=\"line\"></span><br><span class=\"line\">- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -</span><br><span class=\"line\"></span><br><span class=\"line\">Press Enter to Continue</span><br></pre></td></tr></table></figure>\n<p>这时候，暂时不要继续了，<strong>不要继续了！不要继续了！</strong></p>\n<p>保持这个窗口，我们新开一个命令行窗口，创建文件：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">vim /home/server/.well-known/acme-challenge/hoo8qxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxBBJ2A</span><br></pre></td></tr></table></figure>\n<p>内容请复制获取证书时给的一串字符串，比如我这是这样的：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">hoo8qxxxxxxxxxxxxxxxxxxxxxxxxxxxxBBJ2A.LTb3xxxxxxxxxxxxxxxxxxxxxxxxxxxxxoHys</span><br></pre></td></tr></table></figure>\n<p>保存好文件后，先用浏览器访问一下<code>http://youdomain.com/.well-known/acme-challenge/hoo8qxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxBBJ2A</code>，看能否正常输出内容。</p>\n<p>如果不能正常输出，请检查之前的步骤。</p>\n<p>如果正常，回到之前的窗口，按回车继续获取证书，通常成功你就看到如下内容：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">IMPORTANT NOTES:</span><br><span class=\"line\"></span><br><span class=\"line\"> - Congratulations! Your certificate and chain have been saved at:</span><br><span class=\"line\">   /etc/letsencrypt/live/youdomain.com/fullchain.pem</span><br><span class=\"line\">   Your key file has been saved at:</span><br><span class=\"line\">   /etc/letsencrypt/live/youdomain.com/privkey.pem</span><br><span class=\"line\">   Your cert will expire on 2021-06-06. To obtain a new or tweaked</span><br><span class=\"line\">   version of this certificate in the future, simply run certbot</span><br><span class=\"line\">   again. To non-interactively renew *all* of your certificates, run</span><br><span class=\"line\">   &quot;certbot renew&quot;</span><br><span class=\"line\"></span><br><span class=\"line\"> - If you like Certbot, please consider supporting our work by:</span><br><span class=\"line\"></span><br><span class=\"line\">   Donating to ISRG / Let&#x27;s Encrypt:   https://letsencrypt.org/donate</span><br><span class=\"line\">   Donating to EFF:                    https://eff.org/donate-le</span><br></pre></td></tr></table></figure>\n<p>至此，证书已经成功获取，证书保存在：<code>/etc/letsencrypt/live/youdomain.com</code>目录下。</p>\n<h3 id=\"2.4-给你项目配置证书\">2.4 给你项目配置证书<a title=\"#2.4-给你项目配置证书\" href=\"#2.4-给你项目配置证书\"></a></h3>\n<p>编辑你项目的<code>app.js</code>，添加以下内容:</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">const</span> https = <span class=\"built_in\">require</span>(<span class=\"string\">&#x27;https&#x27;</span>);</span><br><span class=\"line\"><span class=\"keyword\">const</span> fs = <span class=\"built_in\">require</span>(<span class=\"string\">&#x27;fs&#x27;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">const</span> options = &#123;</span><br><span class=\"line\">  key: fs.readFileSync(<span class=\"string\">&#x27;/etc/letsencrypt/live/youdomain.com/privkey.pem&#x27;</span>),</span><br><span class=\"line\">  cert: fs.readFileSync(<span class=\"string\">&#x27;/etc/letsencrypt/live/youdomain.com/fullchain.pem&#x27;</span>),</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// 创建https服务</span></span><br><span class=\"line\">https.createServer(options, <span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\">req, res</span>) </span>&#123;</span><br><span class=\"line\">  res.writeHead(<span class=\"number\">200</span>);</span><br><span class=\"line\">  res.end(<span class=\"string\">&quot;hello world\\n&quot;</span>);</span><br><span class=\"line\">&#125;).listen(<span class=\"number\">8443</span>); <span class=\"comment\">// 端口号任意</span></span><br></pre></td></tr></table></figure>\n<p>保存后，启动你的项目。</p>\n<h3 id=\"2.5-重新配置nginx\">2.5 重新配置nginx<a title=\"#2.5-重新配置nginx\" href=\"#2.5-重新配置nginx\"></a></h3>\n<p>编辑<code>/etc/nginx/conf.d/youdomain.com.conf</code>:</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">server &#123;</span><br><span class=\"line\">  listen 443; # 将原来的80换成443</span><br><span class=\"line\"></span><br><span class=\"line\">  server_name youdomain.com; # 设置你的域名</span><br><span class=\"line\">  location / &#123;</span><br><span class=\"line\">    proxy_pass http://127.0.0.1:8443; # 端口号和项目端口号保持一致</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">  #</span><span class=\"bash\"> 以下内容可以删除了</span></span><br><span class=\"line\">  location ^~ /.well-known/acme-challenge/ &#123;</span><br><span class=\"line\">    default_type &quot;text/plain&quot;;</span><br><span class=\"line\">    root     /home/server/;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>保存配置，并重启。</p>\n<h3 id=\"2.6-测试\">2.6 测试<a title=\"#2.6-测试\" href=\"#2.6-测试\"></a></h3>\n<p>完成上面的步骤，不出问题，应该可以使用https访问node项目了。</p>\n<p>浏览器访问：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">https://youdomain.com</span><br></pre></td></tr></table></figure>","next":{"title":"Nest.js大法-上","link":"Learning/3534afa74a70"},"plink":"https://www.zzboy.cn/Learning/b06654da20be/","toc":[{"id":"一、环境准备","title":"一、环境准备","index":"1"},{"id":"二、配置步骤","title":"二、配置步骤","index":"2","children":[{"id":"2.1-创建辅助文件","title":"2.1 创建辅助文件","index":"2.1"},{"id":"2.2-编辑nginx配置文件","title":"2.2 编辑nginx配置文件","index":"2.2"},{"id":"2.3-开始获取证书","title":"2.3 开始获取证书","index":"2.3"},{"id":"2.4-给你项目配置证书","title":"2.4 给你项目配置证书","index":"2.4"},{"id":"2.5-重新配置nginx","title":"2.5 重新配置nginx","index":"2.5"},{"id":"2.6-测试","title":"2.6 测试","index":"2.6"}]}],"reward":true,"copyright":{"author":"Patrick Jun","link":"<a href=\"https://www.zzboy.cn/Learning/b06654da20be/\" title=\"使用Let's Encrypt给node.js项目添加SSL证书\">https://www.zzboy.cn/Learning/b06654da20be/</a>","license":"自由转载-非商用-禁止演绎-保持署名 (<a href=\\\"https://creativecommons.org/licenses/by-nc-sa/4.0/\\\" rel=\\\"external nofollow\\\" target=\\\"_blank\\\">CC BY-NC-ND 4.0</a>)","published":"March 8, 2021"}}